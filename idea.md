# 面向可编程网络的自动化测试

数据中心的网络交换机逐渐从固定功能的交换机演变成可编程交换机，可编程交换机为我们提供了更加丰富的能力，我们可以在交换机上安装APP来达到自动化的网络测试的目的，充分测试“部署在数据平面的规则”的工作是否符合预期。可以抽象理解为，在数据中心场景下，拓展ICMP协议，丰富ping/traceroute功能。

## 交换机程序的设计

1. 网包格式: 我们使用1bit信号X来标志“该网包是否为测试网包”，预留32bit用于记录测试网包ID，复用TTL标志位来指定网包经过的跳数(TTL清零的时候)；
2. 网包可由端侧产生，也可由运行在交换机CPU上的程序下发从端口发出
3. 当交换机/端侧收到网包的标志位X置1，则对测试网包进行相应处理并记录(根据配置，可以记录所处交换机队列、时间戳、经过的各个Table命中的表项等等。可以记录在交换机的CPU中，同时记录下网包ID，等待分析器的query；也可以像INT一样插到网包中)；如果发现TTL已经清零，则网包完整记录到CPU中并结束对该网包的转发处理。
4. 分析器可以根据网包ID，综合所有交换机的记录/网包本身的记录，完整恢复出网包在网络中的详细处理过程。

## 测试网包生成算法

1. ATPG和Pingmesh生成测试路径的时候，只有端侧server可以收发测试网包，导致测试网包存在很大冗余；由于我们可以指定任意的网络设备作为发送端、任意网络设备作为接收端；测试路径的生成可以更加优化。
2. 测试路径生成和分析器汇总分析所有记录，使用Spark/Flink等大数据引擎以加速。
